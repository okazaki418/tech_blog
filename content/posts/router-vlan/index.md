+++
title = "業務用ルータのVLAN"
date = 2023-10-31T14:54:44+09:00
tags = ["IX", "RTX", "VLAN"]
draft = false
+++

### 業務用ルータ
ネットワークのお勉強をしていると、業務用ルータが欲しくなってきます。  
個人で買うなら大体Ciscoの800 MシリーズかヤマハのRTXシリーズ、NECのIXシリーズですかね。  
まあ大体VPNの仕様とかメーカの好き嫌いとかコマンド体系の慣れとかで決めると思います。  
初心者とか学生だと値段ですかね。  
しかし全く気にしていなかったのですが、VLANの仕様にもそこそこ差があったみたいですね。
この間色々あって発覚しました。  
どうせならと思い、ここに記録しておこうと思います。  

### 事の発端
僕は学科のネットワークの管理をしていますが、本当に学科だけのためそれ以上の情報を与えられていません。  
~~というか教えてくれませんでした（白目）~~  
なんならフロアスイッチすら触れません。  
サーバルームの壁の情報コンセントから降ってくるタグVLANをよしなにするだけです。  
というのも昔、教授陣がそこそこな無理を言って、学科ネットワークの管理を学科に任せてくれるようにしたみたいです（他学科は業者管理）。  
~~お陰で若干学校のネットワークを管理している人たちとうちの学科は仲が悪いみたいです。~~  

ということでタグVLANをうまいこと処理しなければなりません。  
しかし恐ろしいことに、学科のメインルータには情報コンセント2つにそれぞれLANケーブルを挿して、2つのネットワークと接続しているということにしていました。  

{{< figure src="network.png" alt="学科ネットワーク" width="300" height=auto >}}

WAN側のポートに1つ、LAN側のポートに1つですね。  
xxx.xxx.xxx.0/24は上位ネットワークのアドレスみたいで、RTXのデフォルトゲートウェイはxxx.xxx.xxx.254か何かに設定されていたと思います。  
こっちは赤い線で情報コンセントでWAN側のポートと繋がっている方のアドレスですね。  
学科で実際に用いているのはxxx.xxx.yyy.0/24だけですので、だったらこっちは普通のLANとして処理してしまえということで、LAN側のポートと情報コンセントを更に繋いでうまいことやっていました。  
これは何がどうなってるんでしょうね？  
昔管理していた（ネットワークを構築した）学生はどういう発想だったのでしょうか。  
何もわかりません。  
なぜ何もわからないかというと、ネットワークを構築したのが10年以上前だからです。  
ついでにコロナ禍でドキュメントが飛んだからです。
そしてxxx.xxx.yyy.0/24で使ってた方の情報コンセントが壊れたからです（白目）  

### 情報コンセントの故障
情報コンセントが壊れて学科ネットワークが停止してから、このイカれた構成に気づきました。  
調べておけばよかった…  
情報コンセントを直してもらおうにも、大学側はすぐに対応してくれません。  
というか仲が悪いので業者まで話が通ってるかもわかりません。  
~~転載時点で直ってないから多分話も通ってなかったですね。~~  
まあ幸いイカれた構成を元のタグVLANに直せばいいだけなので楽勝ですね。  
と思ったのですがここでアクシデントが置きます。  
RTXはタグを外せないんですね。  

### RTXの弱点
一応[公式のドキュメント](https://network.yamaha.com/setting/switch/virtualization/vlan/tag_vlan)にはタグVLANとは書いているのですが、これはあくまでタグVLAN対応スイッチの中継にしか使えないという意味らしいんですよね。  
別でタグを外せるスイッチを持ってこないと駄目みたいです。  
嘘だろ…  
ちなみにNECのIXは外せるみたいです。  
[公式のQ&A](https://jpn.nec.com/univerge/ix/faq/bridge.html)にも書いています。  
これは盲点だった…  

### タグVLANの必要性
というわけでRTXはタグVLANの対応が怪しいという話でしたが、果たしてタグVLANはそんなに必要でしょうか？
VLANは大規模なネットワークだと必須ですが、正直誤家庭には要らない気がします。  
ポートVLANくらいなら使うかもしれませんが、タグVLANなんかは必要ないのではないでしょうか。  
というかタグVLAN使うときには、業務用ルータの他にアホほどスイッチがあると思うのでそっちで対応すれば良いのでは…？  
そう考えるとRTXがタグを外せなくてもまあ妥当かもしれませんね。  

### おわり
タグVLANの需要を考えると（少なくとも誤家庭で利用するときには）RTXが劣っている！とは一概に言えません。  
何なら需要に合わせた素晴らしいコストカットとも思えます。  
なんならNECのIXもVPNでいうとL2TPv3に対応していないですからね（RTXはしていたはず）。  
ただもしかしたらそこを重要にしている人もいるかも知れないので、そういう人たちはそこらへんの仕様も読みながらうまいこと選んでみると幸せになれるかもしれません。  

### 追伸
ちなみに学科ネットワークは余っていたRTXをもう1台引っ張り出して、2日間サーバルームに籠もることでなんやかんやでうまいこと直しました。  
このとき余ってるのがVLAN対応L3SWとかIXだったら楽だったんですけれどね。  
インフラエンジニアという職業はきっとこういうことをたくさん経験しているんだろうなあ…  
大変ですけれどちょっと面白そうですね。
